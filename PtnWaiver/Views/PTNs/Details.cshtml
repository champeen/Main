@model PtnWaiver.ViewModels.PtnViewModel

@{
    ViewData["Title"] = "Details";
}
<div class="row">
    <div class="col-4">
        <h1 style="display:inline">
            <span class="me-2 text-nowrap">
                PTN
            </span>
            <span class="" title="Create New PTN based on this PTN.  Include all Details only. Status will be set to 'Draft' and PTN Creator will be you.">
                @Html.ActionLink("Clone", "Clone", new { id = @Model?.PTN?.Id, tab = "Details" }, new { @class = "btn btn-success align-middle" })
                @* @Html.ActionLink("Download New Equipment Checklist","DownloadNewEquipmentChecklist","ChangeRequests", new {id=@Model.ChangeRequest.Id}, new {@class="btn btn-secondary", title="Download 'New Equipment Checklist' Spreadsheet to Download Folder"}) *@
            </span>
        </h1>
    </div>
    <div class="col-8 text-end">
        <h4>
            <span class="fw-bold">
                @Html.DisplayFor(model => model.PTN.DocId)
            </span>
        </h4>
        <h4>
            @Html.DisplayNameFor(model => model.PTN.Status):
            @if (Model.PTN.Status == "Rejected")
            {
                <span class="text-danger fw-bold">Rejected</span>
            }
            else
            {
                <span class="text-success fw-bold">
                    @Html.DisplayFor(model => model.PTN.Status)
                </span>
            }
        </h4>
    </div>
</div>
<nav class="my-5">
    <ul class="nav nav-tabs" id="nav-tab" role="tablist">
        <li class="nav-item">
            <a class="nav-link @Model.TabActiveDetail fw-bolder" id="nav-detail-tab" data-bs-toggle="tab" href="#nav-detail" role="tab" aria-controls="nav-home" aria-selected="true">Details</a>
        </li>
        @* <li class="nav-item ms-auto"> *@
        <li class="nav-item">
            <a class="nav-link @Model.TabActiveAttachmentsPtn fw-bolder" id="nav-attachmentsPtn-tab" data-bs-toggle="tab" href="#nav-attachmentsPtn" role="tab" aria-controls="nav-profile" aria-selected="false">Upload Template (@Model.AttachmentsPtn.Count.ToString())</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @Model.TabActivePtnApproval @Model.TabSubmitPtnForApprovalDisabled fw-bolder" id="nav-ptnApproval-tab" data-bs-toggle="tab" href="#nav-ptnApproval" role="tab" aria-controls="nav-profile" aria-selected="false">
                Submit PTN for Approval
                <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-html="true" title="Disabled if there is not an attachment. Download templete in previous step, complete, and upload/attach to the PTN to get to the next stage.">
                </i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @Model.TabActivePtnAdminApproval @Model.TabApprovePtnDisabled fw-bolder" id="nav-ptnAdminApproval-tab" data-bs-toggle="tab" href="#nav-ptnAdminApproval" role="tab" aria-controls="nav-profile" aria-selected="false">
                Approve PTN
                <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-html="true" title="Disabled if PTN creator has not submitted for Admin review. Must submit PTN for review in previous stage to get to the next stage.">
                </i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @Model.TabActiveWaivers @Model.TabActiveWaiversDisabled fw-bolder" id="nav-activeWaivers-tab" data-bs-toggle="tab" href="#nav-activeWaivers" role="tab" aria-controls="nav-profile" aria-selected="false">
                Waivers (@Model.PTN.Waivers.Count.ToString())
                <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-html="true" title="Disabled if Admin has not approved. Must have a PTN administrator approve PTN to get to the next stage of adding Waiver(s).">
                </i>
            </a>
        </li>
    </ul>
</nav>

<div class="tab-content" id="nav-tabContent">
    @******************************************************************************************************************@
    @*  DETAIL TAB ****************************************************************************************************@
    @******************************************************************************************************************@
    <div class="tab-pane fade show @Model.TabActiveDetail" id="nav-detail" role="tabpanel" aria-labelledby="nav-home-tab">

        <!-- Top actions -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="d-flex gap-2">
                @if (ViewBag.IsAdmin == true || ViewBag.Username == Model.PTN.CreatedUser)
                {
                    @Html.ActionLink("Edit", "Edit",
                    new { id = @Model?.PTN?.Id, tab = "Details" },
                                new { @class = "btn btn-primary" })
                                }

                @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                {
                    @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-outline-secondary" })
                }
                else
                {
                    @Html.ActionLink("Back to List", "Index", "Home", null, new { @class = "btn btn-outline-secondary" })
                }
            </div>
        </div>

        <!-- General Information -->
        <div class="card h-100 border-3 shadow-sm rounded-4 mt-4 mb-3">
            <div class="card-header bg-light border-bottom">
                <h5 class="mb-0 fw-bold">General Information</h5>
            </div>
            <div class="card-body pt-0">
                <div class="row g-4 mt-1">
                    <!-- Left column -->
                    <div class="col-lg-6">
                        <dl class="row mb-0">
                            <dt class="col-sm-3 text-sm-end fw-bold">
                                @Html.DisplayNameFor(m => m.PTN.Title)
                            </dt>
                            <dd class="col-sm-9">@Html.DisplayFor(m => m.PTN.Title)</dd>

                            <dt class="col-sm-3 text-sm-end fw-bold">
                                @Html.DisplayNameFor(m => m.PTN.OriginatingGroup)
                            </dt>
                            <dd class="col-sm-9">@Html.DisplayFor(m => m.PTN.OriginatingGroup)</dd>

                            <dt class="col-sm-3 text-sm-end fw-bold">
                                @Html.DisplayNameFor(m => m.PTN.ProductSize)
                            </dt>
                            <dd class="col-sm-9">@Html.DisplayFor(m => m.PTN.ProductSize)</dd>

                            <dt class="col-sm-3 text-sm-end fw-bold">
                                @Html.DisplayNameFor(m => m.PTN.isWaferingDepartment)
                            </dt>
                            <dd class="col-sm-9">
                                @if (Model.PTN.isWaferingDepartment == true)
                                {
                                    <span class="badge bg-success">Yes</span>
                                }
                                else if (Model.PTN.isWaferingDepartment == false)
                                {
                                    <span class="badge bg-danger">No</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary-subtle text-secondary border">Not set</span>
                                }
                            </dd>

                            <dt class="col-sm-3 text-sm-end fw-bold">
                                @Html.DisplayNameFor(m => m.PTN.Comments)
                            </dt>
                            <dd class="col-sm-9">
                                @if (!string.IsNullOrWhiteSpace(Model.PTN.Comments))
                                {
                                    @Html.DisplayFor(m => m.PTN.Comments)
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </dd>

                            <dt class="col-sm-3 text-sm-end fw-bold">
                                @Html.DisplayNameFor(m => m.PTN.RejectedReason)
                            </dt>
                            <dd class="col-sm-9">
                                @if (!string.IsNullOrWhiteSpace(Model.PTN.RejectedReason))
                                {
                                    @Html.DisplayFor(m => m.PTN.RejectedReason)
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </dd>
                        </dl>
                    </div>

                    <!-- Right column -->
                    <div class="col-lg-6">
                        <dl class="row mb-0">
                            <!-- Subject Types -->
                            <div class="row">
                                <dt class="col-sm-3 my-1 text-end fw-bold">
                                    @Html.DisplayNameFor(m => m.PTN.SubjectType)
                                </dt>
                                <dd class="col-sm-9 my-1">
                                    @if (Model.PTN.SubjectType != null && Model.PTN.SubjectType.Any())
                                    {
                                        foreach (var st in Model.PTN.SubjectType)
                                        {
                                            <span class="badge bg-light text-dark border me-1">@st</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </dd>
                            </div>

                            <!-- Group Approvers -->
                            <div class="row">
                                <dt class="col-sm-3 my-1 text-end fw-bold">
                                    @Html.DisplayNameFor(m => m.PTN.GroupApprover)
                                </dt>
                                <dd class="col-sm-9 my-1">
                                    @if (Model.PTN.GroupApprover != null && Model.PTN.GroupApprover.Any())
                                    {
                                        <div class="d-flex flex-wrap gap-1">
                                            @foreach (var g in Model.PTN.GroupApprover)
                                            {
                                                <span class="badge bg-light text-dark border">@g</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- User & Timestamp Info -->
        <div class="card h-100 border-3 shadow-sm rounded-4 mt-4">
            <div class="card-header bg-light border-bottom">
                <h5 class="mb-0 fw-bold">User &amp; Timestamp Info</h5>
            </div>
            <div class="card-body pt-2">
                <div class="row g-3">
                    <!-- Created -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-plus-circle text-success"></i>
                                    <h6 class="mb-0 text-uppercase text-muted small">Created</h6>
                                </div>
                            </div>
                            <div class="card-body pt-2">
                                <dl class="row mb-0 small">
                                    <dt class="col-5 text-muted">Username</dt>
                                    <dd class="col-7">
                                        @if (!string.IsNullOrWhiteSpace(Model.PTN.CreatedUser))
                                        {
                                            @Model.PTN.CreatedUser
                                        }
                                        else
                                        {
                                            @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                        }
                                    </dd>

                                    <dt class="col-5 text-muted">Full name</dt>
                                    <dd class="col-7">
                                        @if (!string.IsNullOrWhiteSpace(Model.PTN.CreatedUserFullName))
                                        {
                                            @Model.PTN.CreatedUserFullName
                                        }
                                        else
                                        {
                                            @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                        }
                                    </dd>

                                    <dt class="col-5 text-muted">Email</dt>
                                    <dd class="col-7">
                                        @if (!string.IsNullOrWhiteSpace(Model.PTN.CreatedUserEmail))
                                        {
                                            <a href="mailto:@Model.PTN.CreatedUserEmail">@Model.PTN.CreatedUserEmail</a>
                                        }
                                        else
                                        {
                                            @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                        }
                                    </dd>

                                    <dt class="col-5 text-muted">Date</dt>
                                    <dd class="col-7">
                                        @if (Model.PTN.CreatedDate != DateTime.MinValue)
                                        {
                                            <time>@Model.PTN.CreatedDate.ToString("yyyy-MM-dd HH:mm")</time>
                                        }
                                        else
                                        {
                                            @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                        }
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- Modified -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-pencil-square text-warning"></i>
                                    <h6 class="mb-0 text-uppercase text-muted small">Modified</h6>
                                </div>
                            </div>
                            <div class="card-body pt-2">
                                @if (string.IsNullOrWhiteSpace(Model.PTN.ModifiedUser) &&
                                                                string.IsNullOrWhiteSpace(Model.PTN.ModifiedUserFullName) &&
                                                                string.IsNullOrWhiteSpace(Model.PTN.ModifiedUserEmail) &&
                                                                !Model.PTN.ModifiedDate.HasValue)
                                {
                                    <div class="alert alert-light border small mb-0">No modifications recorded.</div>
                                }
                                else
                                {
                                    <dl class="row mb-0 small">
                                        <dt class="col-5 text-muted">Username</dt>
                                        <dd class="col-7">
                                            @if (!string.IsNullOrWhiteSpace(Model.PTN.ModifiedUser))
                                            {
                                                @Model.PTN.ModifiedUser
                                            }
                                            else
                                            {
                                                @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                            }
                                        </dd>

                                        <dt class="col-5 text-muted">Full name</dt>
                                        <dd class="col-7">
                                            @if (!string.IsNullOrWhiteSpace(Model.PTN.ModifiedUserFullName))
                                            {
                                                @Model.PTN.ModifiedUserFullName
                                            }
                                            else
                                            {
                                                @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                            }
                                        </dd>

                                        <dt class="col-5 text-muted">Email</dt>
                                        <dd class="col-7">
                                            @if (!string.IsNullOrWhiteSpace(Model.PTN.ModifiedUserEmail))
                                            {
                                                <a href="mailto:@Model.PTN.ModifiedUserEmail">@Model.PTN.ModifiedUserEmail</a>
                                            }
                                            else
                                            {
                                                @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                            }
                                        </dd>

                                        <dt class="col-5 text-muted">Date</dt>
                                        <dd class="col-7">
                                            @if (Model.PTN.ModifiedDate.HasValue)
                                            {
                                                <time>@Model.PTN.ModifiedDate.Value.ToString("yyyy-MM-dd HH:mm")</time>
                                            }
                                            else
                                            {
                                                @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                            }
                                        </dd>
                                    </dl>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Deleted -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-trash3 text-danger"></i>
                                    <h6 class="mb-0 text-uppercase text-muted small">Deleted</h6>
                                </div>
                            </div>
                            <div class="card-body pt-2">
                                @if (string.IsNullOrWhiteSpace(Model.PTN.DeletedUser) &&
                                                                string.IsNullOrWhiteSpace(Model.PTN.DeletedUserFullName) &&
                                                                string.IsNullOrWhiteSpace(Model.PTN.DeletedUserEmail) &&
                                                                !Model.PTN.DeletedDate.HasValue)
                                {
                                    <div class="alert alert-light border small mb-0">Not deleted.</div>
                                }
                                else
                                {
                                    <dl class="row mb-0 small">
                                        <dt class="col-5 text-muted">Username</dt>
                                        <dd class="col-7">
                                            @if (!string.IsNullOrWhiteSpace(Model.PTN.DeletedUser))
                                            {
                                                @Model.PTN.DeletedUser
                                            }
                                            else
                                            {
                                                @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                            }
                                        </dd>

                                        <dt class="col-5 text-muted">Full name</dt>
                                        <dd class="col-7">
                                            @if (!string.IsNullOrWhiteSpace(Model.PTN.DeletedUserFullName))
                                            {
                                                @Model.PTN.DeletedUserFullName
                                            }
                                            else
                                            {
                                                @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                            }
                                        </dd>

                                        <dt class="col-5 text-muted">Email</dt>
                                        <dd class="col-7">
                                            @if (!string.IsNullOrWhiteSpace(Model.PTN.DeletedUserEmail))
                                            {
                                                <a href="mailto:@Model.PTN.DeletedUserEmail">@Model.PTN.DeletedUserEmail</a>
                                            }
                                            else
                                            {
                                                @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                            }
                                        </dd>

                                        <dt class="col-5 text-muted">Date</dt>
                                        <dd class="col-7">
                                            @if (Model.PTN.DeletedDate.HasValue)
                                            {
                                                <time>@Model.PTN.DeletedDate.Value.ToString("yyyy-MM-dd HH:mm")</time>
                                            }
                                            else
                                            {
                                                @Html.Raw("<span class='badge bg-secondary-subtle text-secondary border'>Not set</span>")
                                            }
                                        </dd>
                                    </dl>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom actions -->
        <div class="d-flex justify-content-start mt-4">
            <div class="d-flex gap-2">
                @if (ViewBag.IsAdmin == true || ViewBag.Username == Model.PTN.CreatedUser)
                {
                    @Html.ActionLink("Edit", "Edit",
                    new { id = @Model?.PTN?.Id, tab = "Details" },
                                new { @class = "btn btn-primary" })
                                }

                @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                {
                    @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-outline-secondary" })
                }
                else
                {
                    @Html.ActionLink("Back to List", "Index", "Home", null, new { @class = "btn btn-outline-secondary" })
                }
            </div>
        </div>
    </div>

    @******************************************************************************************************************@
    @*  ATTACHMENTS TAB  **********************************************************************************************@
    @******************************************************************************************************************@
    <div class="tab-pane fade show @Model.TabActiveAttachmentsPtn" id="nav-attachmentsPtn" role="tabpanel" aria-labelledby="nav-attachmentsPtn-tab">
        <div class="mt-5">
            @*<h4 class="mt-5">Attachments</h4>*@
            @*    <a asp-action="Edit" asp-route-id="@Model?.Id">Edit</a> |*@
            @* @Html.ActionLink("Back to List","Index", new {}, new {@class="btn btn-secondary"}) *@
            <div class="row mb-4">
                <div class="col-12">
                    <div class="text-nowrap fs-6">
                        <span class="fw-bold">STEP 1:</span> Download PTN (PCCB) Template
                        @* @Html.ActionLink("Download PTN Template","Detail", new {}, new {@class="btn btn-success mt-3 ms-2", @style="display:inline !important;"}) *@
                        @*                      <a href="https://sksiltronusa.sharepoint.com/sites/Vault/NoCRWithoutTrn/Forms/AllItems.aspx?view=7&q=TMP%2D0506" target="_blank" class="btn btn-primary mt-3 ms-2" style="display:inline !important;">Get PTN (PCCB) Template</a> *@
                        <a href="https://sksiltronusa.sharepoint.com/sites/Vault/NoCRWithoutTrn/Forms/AllItems.aspx?view=7&q=PCCB%20Template%2Epptx%20TMP%2D0506" target="_blank" class="btn btn-primary mt-3 ms-2" style="display:inline !important;">Get PTN (PCCB) Template</a>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="text-nowrap fs-6">
                        <span class="fw-bold">STEP 2:</span> Complete PTN (PCCB) Template
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="text-nowrap fs-6">
                        <span class="fw-bold">STEP 3:</span> Upload Completed PTN (PCCB) Template
                    </div>
                </div>
            </div>
            <div class="mx-5">
                @using (Html.BeginForm("SaveFile", "PTNs", new { id = Model.PTN.Id }, FormMethod.Post, false, new { enctype = "multipart/form-data" }))
                {
                    <div class="control-label fw-bold mt-5 mb-2">
                        <strong>Upload Completed PTF (PCCB) Template:</strong>
                    </div>
                    <div class="form-group mb-3">
                        <div class="row">
                            <div class="col-9">
                                <input type="file" name="fileAttachment" class="form-control" @ViewBag.DisableAttachmentUpload />
                                <div class="form-group text-danger fw-bold">
                                    @*<input asp-for="FileAttachmentError" class="form-control" />*@
                                    @Html.DisplayFor(m => m.FileAttachmentError)
                                </div>
                            </div>
                            <div class="col-xl-3 block">
                                <input type="submit" value="Upload Completed PTN (PCCB) Template" class="form-control btn btn-success" @ViewBag.DisableAttachmentUpload>
                            </div>
                        </div>
                    </div>
                }
                <table class="table table-bordered table-striped mt-5">
                    <thead class="table-primary">
                        <tr>
                            <th>
                                File Name
                            </th>
                            <th>
                                Date Added
                            </th>
                            <th>
                                Size
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.AttachmentsPtn)
                        {
                            <tr>
                                <td>
                                    @Html.DisplayFor(modelItem => item.Name)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.CreatedDate)
                                </td>
                                <td>
                                    @{
                                        var size = item.Size / 1000 < 1 ? item.Size.ToString() + " bytes" : (item.Size / 1000).ToString("N0") + " KB";
                                    }
                                    @* @Html.DisplayFor(modelItem => item.Size.ToString("#,##0")) KB *@
                                    @size
                                </td>
                                <td>
                                    @*<a href="@item.FullPath" data-type="URL" target="_blank">View File</a>*@
                                    @*<a asp-controller="ChangeRequests" asp-action="DisplayAttachment" asp-route-id="@item.Id">Edit</a>*@
                                    @Html.ActionLink("Download File", "DownloadFile", "PTNs", new { id = @Model.PTN.Id, fileName = item.Name, sourcePath = item.FullPath }, new { @class = "btn btn-secondary", title = "Download to Download Folder" })
                                    @if (Model.PTN.Status == "Draft" && (ViewBag.IsAdmin || ViewBag.Username == Model.PTN.CreatedUser))
                                    {
                                        @Html.ActionLink("Delete", "DeleteFile", "PTNs", new { id = @Model.PTN.Id, fileName = item.Name, sourcePath = item.FullPath }, new { @class = "btn btn-danger", title = "Delete Attachment" })
                                    }
                                    @*<a asp-controller="ImplementationFinalApprovalResponses" asp-action="Edit" asp-route-id="@item.Id">Edit</a>*@
                                </td>
                            </tr>
                        }
                    </tbody>
                    @if (Model.AttachmentsPtn.Count() == 0)
                    {
                        <tr>
                            <td>No data found</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    }
                </table>
            </div>
            @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
            {
                @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary mt-3" })
            }
            else
            {
                @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary mt-3" })
            }
        </div>
    </div>

    @******************************************************************************************************************@
    @*  SUBMIT FOR ADMIN APPROVAL TAB (Card-wrapped) ******************************************************************@
    @******************************************************************************************************************@
    <div class="tab-pane fade show @Model.TabActivePtnApproval" id="nav-ptnApproval" role="tabpanel" aria-labelledby="nav-ptnApproval-tab">
        <div class="card h-100 border-3 shadow-sm rounded-3 mt-3">
            <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">Submit PTN for Approval</h5>
            </div>

            <div class="card-body">
                @if (Model.PTN.Status == "Draft")
                {
                    if (ViewBag.IsAdmin == true || ViewBag.Username == Model.PTN.CreatedUser)
                    {
                        <div class="alert alert-info">
                            Once submitted for approval, you can only edit the <strong>Comment</strong> or <strong>PTR Number</strong> fields.
                            Make sure everything is complete before submitting for approval.
                        </div>

                        @* Duplicate actions at body top (optional). Remove if header actions are enough. *@
                        <div class="d-flex gap-2 mb-2">
                            @Html.ActionLink(
                            "Submit for Approval",
                                        "SubmitPtnForApproval",
                                        "PTNs",
                                        new { id = Model.PTN.Id },
                                        new { @class = "btn btn-success", onclick = "return DisplayProgressMessage(this, 'Saving...');" })
                            @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                            {
                                @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary" })
                            }
                            else
                            {
                                @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary" })
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            PTN creator or a PTN administrator must submit this PTN for approval to move to the next phase.
                        </div>
                        @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                        {
                            @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary mt-3" })
                        }
                        else
                        {
                            @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary mt-3" })
                        }
                    }
                }
                else
                {
                    var hasSubmissionRecord = !string.IsNullOrWhiteSpace(Model.PTN.SubmittedForApprovalUser);
                    var rejectedBefore = Model.PTN.RejectedBeforeSubmission == true;
                    var canSubmit = (ViewBag.IsAdmin == true) || (ViewBag.Username == Model.PTN.CreatedUser);

                    if (hasSubmissionRecord)
                    {
                        if (rejectedBefore)
                        {
                            <div class="alert alert-danger mb-2">
                                PTN has been <strong>Rejected</strong> by
                                <strong>@Model.PTN.SubmittedForApprovalUserFullName</strong>
                                on <strong>@Model.PTN.SubmittedForApprovalDate</strong>.
                            </div>
                            <div>
                                <span class="fw-bold">Reason for Rejection: </span>@Model.PTN.RejectedReason
                            </div>
                            @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                            {
                                @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary mt-3" })
                            }
                            else
                            {
                                @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary mt-3" })
                            }
                        }
                        else
                        {
                            <div class="alert alert-success mb-0">
                                PTN has been <strong>submitted for approval</strong> by
                                <strong>@Model.PTN.SubmittedForApprovalUserFullName</strong>
                                on <strong>@Model.PTN.SubmittedForApprovalDate</strong>.
                            </div>
                            @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                            {
                                @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary mt-3" })
                            }
                            else
                            {
                                @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary mt-3" })
                            }
                        }
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            This PTN has not been submitted for approval yet.
                        </div>

                        @* Optional: allow submit even when not in Draft (if your business rules permit) *@
                        @if (canSubmit)
                        {
                            <div class="d-flex gap-2">
                                @Html.ActionLink(
                                "Submit for Approval",
                                        "SubmitPtnForApproval",
                                        "PTNs",
                                        new { id = Model.PTN.Id },
                                        new { @class = "btn btn-success", onclick = "return DisplayProgressMessage(this, 'Saving...');" })
                                @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                                {
                                    @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary" })
                                }
                                else
                                {
                                    @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary" })
                                }
                            </div>
                        }
                    }
                }

            </div>
        </div>
    </div>

    @******************************************************************************************************************@
    @*  PTN REVIEW APPROVAL *******************************************************************************************@
    @******************************************************************************************************************@
    <div class="tab-pane fade show @Model.TabActivePtnAdminApproval" id="nav-ptnAdminApproval" role="tabpanel" aria-labelledby="nav-ptnAdminApproval-tab">

        @if (TempData["SuccessMessageImpactAssessment"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @TempData["SuccessMessageImpactAssessment"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="row my-3">
            <div class="col-12 text-start">
                @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                {
                    @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary" })
                }
                else
                {
                    @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary" })
                }
            </div>
        </div>
        <table class="table table-bordered table-striped">
            <thead class="align-top align-text-top table-primary">
                <tr>
                    <th>
                        @Html.DisplayNameFor(model => model.GroupApproversReview[0].Group)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.GroupApproversReview[0].PrimaryApproverFullName)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.GroupApproversReview[0].SecondaryApproverFullName)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.GroupApproversReview[0].Status)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.GroupApproversReview[0].ReviewedBy)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.GroupApproversReview[0].ReviewDate)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.GroupApproversReview[0].Comment)
                    </th>
                    <th></th>
                </tr>
            </thead>
            @* <form asp-controller="PTNs" asp-action="Index"> *@
            <tbody id="groupApproverReviewIndexTable">
                @foreach (var item in Model.GroupApproversReview)
                {
                    var color = "";
                    if (item.Status == "Rejected")
                    {
                        color = "text-danger fw-bold";
                    }
                    else if (item.Status == "Approved")
                    {
                        color = "text-success fw-bold";
                    }
                    <tr>
                        <input type="hidden" asp-for="@item.Id" />
                        <td>
                            @Html.DisplayFor(modelItem => item.Group)
                        </td>
                        <td>
                            @if (item.ReviewedBy == null && ViewBag.IsAdmin)
                            {
                                <form asp-action="UpdatePrimaryReviewer" method="post" class="d-flex align-items-center">
                                    <input type="hidden" name="id" value="@item.Id" />
                                    <input type="hidden" name="ptnId" value="@Model.PTN.Id" />
                                    <select name="newReviewer" class="form-control form-select form-select-sm select2 js-reviewer me-2" style="width: 100%" required>
                                        @foreach (SelectListItem emp in ViewBag.Employees)
                                        {
                                            if (item.PrimaryApproverUsername == emp.Value)
                                            {
                                                <option value="@emp.Value" selected="selected">@emp.Text</option>
                                            }
                                            else
                                            {
                                                <option value="@emp.Value">@emp.Text</option>
                                            }
                                        }
                                    </select>
                                    <button type="submit" class="btn btn-sm btn-primary mx-1">Save</button>
                                </form>
                            }
                            else
                            {
                                @Html.DisplayFor(modelItem => item.PrimaryApproverFullName)
                            }
                        </td>
                        <td>
                            @if (item.ReviewedBy == null && ViewBag.IsAdmin)
                            {
                                <form asp-action="UpdateSecondaryReviewer" method="post" class="d-flex align-items-center">
                                    <input type="hidden" name="id" value="@item.Id" />
                                    <input type="hidden" name="ptnId" value="@Model.PTN.Id" />
                                    <select name="newReviewer" class="form-control form-select form-select-sm select2 js-reviewer me-2" style="width: 100%">
                                        @if (string.IsNullOrEmpty(item.SecondaryApproverUsername))
                                        {
                                            <option value="" selected disabled>-- Select Reviewer --</option>
                                        }
                                        @foreach (SelectListItem emp in ViewBag.Employees)
                                        {
                                            if (item.SecondaryApproverUsername == emp.Value)
                                            {
                                                <option value="@emp.Value" selected="selected">@emp.Text</option>
                                            }
                                            else
                                            {
                                                <option value="@emp.Value">@emp.Text</option>
                                            }
                                        }
                                    </select>
                                    <button type="submit" class="btn btn-sm btn-primary mx-1">Save</button>
                                </form>
                            }
                            else
                            {
                                @Html.DisplayFor(modelItem => item.SecondaryApproverFullName)
                            }
                        </td>
                        <td class="@color">
                            @Html.DisplayFor(modelItem => item.Status)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.ReviewedBy)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.ReviewDate)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Comment)
                        </td>
                        <td class="text-nowrap">
                            @if (Model.PTN.Status == "Pending Approval" && (ViewBag.IsAdmin == true || ViewBag.Username == item.PrimaryApproverUsername || ViewBag.Username == item.SecondaryApproverUsername))
                            {
                                @if (item.Status == null || item.Status == "")
                                {
                                    @* <input type="submit" value="Save" class="btn btn-primary" /> *@
                                    @Html.ActionLink("Approve", "GroupApprove", new { ptnId = Model.PTN.Id, groupApproverId = @item.Id, status = "Approved" }, new { @class = "btn btn-success" })
                                }
                                @if (item.Status == null || item.Status == "")
                                {
                                    @Html.ActionLink("Reject", "GroupApprove", new { ptnId = Model.PTN.Id, groupApproverId = @item.Id, status = "Rejected" }, new { @class = "btn btn-danger ms-1" })
                                }
                            }
                        </td>
                    </tr>
                }
            </tbody>
            @* </form> *@
            @if (Model.GroupApproversReview.Count() == 0)
            {
                <tr>
                    <td>No data found</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            }
        </table>
        <div class="row mt-3">
            <div class="col-12 text-start">
                @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                {
                    @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary" })
                }
                else
                {
                    @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary" })
                }
            </div>
        </div>
    </div>
    @******************************************************************************************************************@
    @*  WAIVERS  ******************************************************************************************************@
    @******************************************************************************************************************@
    <div class="tab-pane fade show @Model.TabActiveWaivers" id="nav-activeWaivers" role="tabpanel" aria-labelledby="nav-activeWaivers-tab">
        <div class="">
            <div class="row mt-5">
                <div class="col-12 text-start">
                    <div class="row">
                        <div class="col-3">
                            <h1>Waivers</h1>
                        </div>
                        <div class="col-sm-9 alert-warning">
                            <strong>Note: </strong>Production trial waiver approval requires the same approvers listed on the POR Waiver Form (TMP-0015). The waiver requestor is responsible for ensuring all required approvers are included.
                        </div>
                    </div>

                    <hr />
                    <form asp-controller="Waivers" asp-action="Index">
                        <div class="row">
                            <div class="col-12">
                                <div class="row mb-3">
                                    <div class="col-12 text-start">
                                        <span class="flex-nowrap">
                                            @if (Model.PTN.Status == "Approved")
                                            {
                                                @Html.ActionLink("Create New", "Create", "Waivers", new { ptnId = Model?.PTN?.Id, tab = "Waivers" }, new { @class = "btn btn-success me-1" })
                                            }
                                            @if (ViewBag.SourceString != null && ViewBag.SourceString == "Index")
                                            {
                                                @Html.ActionLink("Back to List", "Index", new { }, new { @class = "btn btn-outline-secondary" })
                                            }
                                            else
                                            {
                                                @Html.ActionLink("Back to List", "Index", "Home", new { }, new { @class = "btn btn-outline-secondary" })
                                            }
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <table class="table table-bordered table-striped">
                        <thead class="align-top align-text-top table-primary">
                            <tr>
                                <th>
                                    Waiver Number
                                </th>
                                <th>
                                    External ID-MES
                                </th>
                                <th>
                                    Revision Number
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Product/Processes
                                </th>
                                <th>
                                    Area(s)
                                </th>
                                <th>
                                    Department Approver
                                </th>
                                <th>
                                    Status
                                </th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="waiverIndexTable">
                            @foreach (var item in Model.PTN.Waivers)
                            {
                                var color = "";
                                if (item.Status == "Draft")
                                {
                                    color = "text-warning fw-bold";
                                }
                                else if (item.Status == "Pending Approval")
                                {
                                    color = "text-primary fw-bold";
                                }
                                else if (item.Status == "Approved")
                                {
                                    color = "text-success fw-bold";
                                }
                                else if (item.Status == "Closed")
                                {
                                    color = "text-success fw-bold";
                                }
                                else if (item.Status == "Rejected")
                                {
                                    color = "text-danger fw-bold";
                                }
                                <tr>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.WaiverNumber)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.ExternalIdMes)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.RevisionNumber)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Description)
                                    </td>
                                    <td>
                                        @* @Html.DisplayFor(modelItem => item.ProductProcess) *@
                                        @if (item.ProductProcess != null)
                                        {
                                            var counter = 0;
                                            @foreach (var productProcess in item.ProductProcess)
                                            {
                                                counter = counter + 1;
                                                <span>@productProcess</span>
                                                if (counter < item.ProductProcess.Count)
                                                {
                                                    <span>,@* &nbsp; *@</span>
                                                }
                                            }
                                        }
                                    </td>
                                    <td>
                                        @* @Html.DisplayFor(modelItem => item.Areas) *@
                                        @if (item.Areas != null)
                                        {
                                            var counter = 0;
                                            @foreach (var areas in item.Areas)
                                            {
                                                counter = counter + 1;
                                                <span>@areas</span>
                                                if (counter < item.Areas.Count)
                                                {
                                                    <span>,@* &nbsp; *@</span>
                                                }
                                            }
                                        }
                                    </td>
                                    <td>
                                        @if (item.GroupApprover != null)
                                        {
                                            var counter = 0;
                                            @foreach (var groupApprover in item.GroupApprover)
                                            {
                                                counter = counter + 1;
                                                <span>@groupApprover</span>
                                                if (counter < item.GroupApprover.Count)
                                                {
                                                    <span>,@* &nbsp; *@</span>
                                                }
                                            }
                                        }
                                    </td>
                                    <td class="@color">
                                        @Html.DisplayFor(modelItem => item.Status)
                                    </td>
                                    <td class="text-nowrap">
                                        @Html.ActionLink("Details", "Details", "Waivers", new { id = @item.Id, tab = "Waivers" }, new { @class = "btn btn-secondary ms-1" })
                                        @if (ViewBag.IsAdmin == true || ViewBag.Username == item.CreatedUser)
                                        {
                                            @if (item.Status != "Draft" && item.Status != "Pending Approval" && item.IsMostCurrentWaiver == true)
                                            {
                                                @Html.ActionLink("Revise", "Revise", "Waivers", new { id = @item.Id, tab = "Waivers" }, new { @class = "btn btn-success ms-1", onclick = "return DisplayProgressMessage(this, 'Saving...');", @title = "Can revise any Waiver that is not in 'Draft' or 'Pending Approval' status, and must be the most current 'Waiver Number'." })
                                            }
                                            @if (item.DeletedDate == null && item.Status == "Draft" && Model.PTN.Status == "Approved")
                                            {
                                                @Html.ActionLink("Delete", "Delete", "Waivers", new { id = @item.Id, tab = "Waivers" }, new { @class = "btn btn-danger ms-1", onclick = "return DisplayProgressMessage(this, 'Saving...');" })
                                            }
                                            @if (item.Status == "Approved")
                                            {
                                                @Html.ActionLink("Close Waiver", "CloseWaiver", "Waivers", new { id = @item.Id }, new { @class = "btn btn-primary ms-1", onclick = "return DisplayProgressMessage(this, 'Saving...');" })
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                        @if (Model.PTN.Waivers.Count() == 0)
                        {
                            <tr>
                                <td>No data found</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
      $('select.js-reviewer').each(function () {
        $(this).select2({
          placeholder: $(this).find('option[disabled][selected]').text() || '-- Select --',
          allowClear: true,
          width: '100%',
          // helps when inside modals or overflowed containers:
          dropdownParent: $(this).closest('form')
        });
      });
    });
</script>